import"../chunks/Bzak7iHL.js";import{p as De,t as ze,v as R,w as Ee,o as Te,x as Ge,f as p,y as re,z as $,A as c,l as s,c as v,d as Ce,B as o,C as I,D as i,E as t,F as u,G as U,H as Ne}from"../chunks/D6nPkcoS.js";import{i as A,s as Oe,a as D}from"../chunks/BDAMK1gS.js";import{b as Be,p as He,e as le,s as ie,a as ne}from"../chunks/D73Bnykk.js";import{r as ce,s as ve,a as Le}from"../chunks/DRPFIkrd.js";import{p as qe,s as Je}from"../chunks/DycXGPVy.js";import{p as de,i as T,m as V,f as Qe,s as me,a as Re}from"../chunks/B5_lSiN-.js";var Ue=p('<div class="empty-chat svelte-kjloo9"><p>No messages yet. Start the conversation!</p></div>'),Ve=p('<img class="message-avatar svelte-kjloo9"/>'),We=p('<div class="message-author svelte-kjloo9"> </div>'),Xe=p('<div><!> <div class="message-content svelte-kjloo9"><!> <div class="message-bubble svelte-kjloo9"> </div> <div class="message-time svelte-kjloo9"> </div></div></div>'),Ye=p('<div class="no-friends svelte-kjloo9"><p>No friends available. <a href="/friends" class="svelte-kjloo9">Add some friends first</a>.</p></div>'),Ze=p('<label class="friend-option svelte-kjloo9"><input type="checkbox" class="svelte-kjloo9"/> <span class="friend-key svelte-kjloo9"> </span></label>'),es=p('<div class="friends-selection svelte-kjloo9"></div>'),ss=p('<div class="modal-overlay svelte-kjloo9" role="button" tabindex="0"><div class="modal svelte-kjloo9" role="dialog" tabindex="0"><h3 class="svelte-kjloo9">Add Members to Group</h3> <p class="modal-description svelte-kjloo9">Select friends to add to this group.</p> <!> <div class="modal-actions svelte-kjloo9"><button class="btn btn-secondary svelte-kjloo9">Cancel</button> <button class="btn btn-primary svelte-kjloo9"> </button></div></div></div>'),as=p('<div class="chat-view svelte-kjloo9"><header class="chat-header svelte-kjloo9"><div class="chat-header-left svelte-kjloo9"><button class="back-btn svelte-kjloo9">‚Üê</button> <div class="chat-info svelte-kjloo9"><h2 class="svelte-kjloo9">Group Chat</h2> <p class="svelte-kjloo9"> </p></div></div> <button class="btn btn-small btn-outline svelte-kjloo9">Add Member</button></header> <div class="messages-container svelte-kjloo9"><!></div> <div class="message-input-container svelte-kjloo9"><form class="svelte-kjloo9"><input placeholder="Type a message..." class="message-input svelte-kjloo9"/> <button type="submit" class="send-btn svelte-kjloo9">Send</button></form></div></div> <!>',1);function vs(ue,G){De(G,!0);const pe=()=>D(qe,"$page",S),C=()=>D(de,"$participants",S),fe=()=>D(Re,"$myPublicKey",S),N=()=>D(Qe,"$friends",S),W=()=>D(V,"$messages",S),[S,be]=Oe();let F=U(()=>pe().params.chatId);const ge=ze();let b=R(""),j=R(!1),d=R(Ee(new Set)),X;async function Y(){try{let e=await T("get_messages",{chatId:s(F)});e.sort((a,r)=>a.timestamp-r.timestamp),V.set(e),console.log("messages loaded: ",e)}catch(e){console.error("Failed to load messages:",e)}}async function O(){try{const e=await T("get_members",{chatId:s(F)}),a=new Map;e.forEach(r=>{a.set(r,{publicKey:r,name:r,avatar:""})}),de.set(a)}catch(e){console.error("Failed to load participants:",e)}}async function Z(){if(console.log("sendMessage",s(b),s(F)),s(b).trim())try{const e=await T("send_message",{chatId:s(F),message:s(b).trim()});console.log("message sent: ",e),V.update(a=>[...a,e]),u(b,"")}catch(e){console.error("Failed to send message:",e)}}function _e(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Z())}function he(e){return C().get(e)||{publicKey:e,name:e,avatar:""}}function ke(e){return e===fe()}function ye(e){return e===void 0?"???":new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function je(e){const a=new Set(s(d));a.has(e)?a.delete(e):a.add(e),u(d,a,!0)}async function we(){if(s(d).size!==0)try{for(const e of s(d))N().find(r=>r.publicKey===e)&&await T("add_member",{chatId:s(F),pubkey:e});u(j,!1),u(d,new Set,!0),me("Members added successfully!"),await O()}catch(e){console.error("Failed to add members:",e),me("Failed to add members",!0)}}Te(async()=>{await O(),await Y(),X=setInterval(async()=>{await O()},3e3),setInterval(async()=>{await Y()},3e3)}),Ge(()=>{clearInterval(X)});var ee=as(),B=re(ee),H=o(B),L=o(H),se=o(L),ae=i(se,2),te=i(o(ae),2),Me=o(te);t(te),t(ae),t(L);var xe=i(L,2);t(H);var q=i(H,2),$e=o(q);{var Ie=e=>{var a=Ue();v(e,a)},Se=e=>{var a=Ne(),r=re(a);le(r,1,W,w=>w.timestamp,(w,M)=>{const g=U(()=>he(s(M).author)),x=U(()=>ke(s(M).author));var _=Xe(),h=o(_);{var Q=n=>{var m=Ve();$(()=>{ve(m,"src",s(g).avatar),ve(m,"alt",s(g).name)}),v(n,m)};A(h,n=>{!s(x)&&s(g)&&n(Q)})}var l=i(h,2),f=o(l);{var K=n=>{var m=We(),Ae=o(m,!0);t(m),$(()=>I(Ae,s(g).name)),v(n,m)};A(f,n=>{!s(x)&&s(g)&&n(K)})}var k=i(f,2),P=o(k,!0);t(k);var y=i(k,2),E=o(y,!0);t(y),t(l),t(_),$(n=>{Je(_,1,`message ${s(x)?"message-mine":"message-other"}`,"svelte-kjloo9"),I(P,s(M).content),I(E,n)},[()=>ye(s(M).timestamp)]),v(w,_)}),v(e,a)};A($e,e=>{W().length===0?e(Ie):e(Se,!1)})}t(q);var oe=i(q,2),J=o(oe),z=o(J);ce(z);var Fe=i(z,2);t(J),t(oe),t(B);var Ke=i(B,2);{var Pe=e=>{var a=ss(),r=o(a),w=i(o(r),4);{var M=l=>{var f=Ye();v(l,f)},g=l=>{var f=es();le(f,5,N,K=>K.publicKey,(K,k)=>{var P=Ze(),y=o(P);ce(y);var E=i(y,2),n=o(E,!0);t(E),t(P),$(m=>{Le(y,m),I(n,s(k).publicKey)},[()=>s(d).has(s(k).publicKey)]),c("change",y,()=>je(s(k).publicKey)),v(K,P)}),t(f),v(l,f)};A(w,l=>{N().length===0?l(M):l(g,!1)})}var x=i(w,2),_=o(x),h=i(_,2),Q=o(h);t(h),t(x),t(r),t(a),$(()=>{h.disabled=s(d).size===0,I(Q,`Add ${s(d).size??""} Member${s(d).size!==1?"s":""}`)}),c("click",_,()=>u(j,!1)),c("click",h,we),c("click",r,ie(function(l){ne.call(this,G,l)})),c("keydown",r,ie(function(l){ne.call(this,G,l)})),c("click",a,()=>u(j,!1)),c("keydown",a,l=>l.key==="Escape"&&u(j,!1)),v(e,a)};A(Ke,e=>{s(j)&&e(Pe)})}$((e,a,r)=>{I(Me,`${e??""} member${a??""}`),Fe.disabled=r},[()=>Object.keys(C()).length,()=>Object.keys(C()).length!==1?"s":"",()=>!s(b).trim()]),c("click",se,()=>ge("backToGroups")),c("click",xe,()=>u(j,!0)),Be(z,()=>s(b),e=>u(b,e)),c("keydown",z,_e),c("submit",J,He(Z)),v(ue,ee),Ce(),be()}export{vs as component};
